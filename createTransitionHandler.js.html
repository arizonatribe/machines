

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: createTransitionHandler.js | machines</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-jsdoc.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/tui-doc.css">

    
        
            <link type="text/css" rel="stylesheet" href="styles/after.css">
        
    
</head>
<body>
<nav class="lnb" id="lnb">
    <div class="logo" style="width: 1px; height: 1px">
        
            <a href="https://github.com/arizonatribe/machines" rel="noopener noreferrer" target="_blank">
                <img src="https://arizonatribe.github.io/machines/styles/logo.png" width="100%" height="100%">
            </a>
        
    </div>
    <div class="title">
        <h1><a href="index.html" class="link">machines</a></h1>
        
            <span class="version">v1.2.0</span>
        
    </div>
    <div class="search-container" id="search-container">
        <input type="text" placeholder="Search">
        <ul></ul>
    </div>
    
    <div class="lnb-api hidden"><h3>Global</h3><ul><li><a href="global.html#_allValuesAreObjects">_allValuesAreObjects</a></li><li><a href="global.html#_allValuesFromTransitionsAreStates">_allValuesFromTransitionsAreStates</a></li><li><a href="global.html#_isObject">_isObject</a></li><li><a href="global.html#createMachine">createMachine</a></li><li><a href="global.html#createTransitionHandler">createTransitionHandler</a></li><li><a href="global.html#getFirstState">getFirstState</a></li><li><a href="global.html#getNextState">getNextState</a></li><li><a href="global.html#nextState">nextState</a></li><li class="hidden"><a href="global.html#TransitionError">TransitionError</a></li><li><a href="global.html#validateStateMachine">validateStateMachine</a></li><li><a href="global.html#wrappedTransitionHandler">wrappedTransitionHandler</a></li></ul></div>
</nav>
<div id="resizer"></div>

<div class="main" id="main">
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const createMachine = require('./createMachine')
const { validateStateMachine } = require('./_internal')

/**
 * Exends the base JavaScript base `Error`
 * @typedef {Object&lt;string, any>} TransitionError
 * @property {string} name The name of the error (in this case "TransitionError")
 * @property {string} data.currentState The current state of the state machine at the time the error was encountered
 */
class TransitionError extends Error {
  constructor(message, state, additionalData = {}) {
    super(message)
    this.name = this.constructor.name
    this.data = {
      ...(
        typeof additionalData === 'object' &amp;&amp; additionalData.constructor.name === 'Object'
          ? additionalData
          : {}
      ),
      currentState: state
    }
  }
}

/**
 * Takes a given state machine and handler and returns a function which is ready to receive the starting "state" value _and_ any starting data, following through the entire sequence of async function until the state stops advancing.
 * Note, a handler will receive the initial data, the starting "state" value and any (optional) dependencies to place into the context for the async functions contained in the handler.
 * A handler doesn't have to be a function but can also be an object whose keys are possible "state" values and whose values are functions that receive the initial data, state machine, and context.
 *
 * @function
 * @name createTransitionHandler
 * @throws {TypeError} If a state machine is not provided
 * @throws {TypeError} If a handler function/object is not provided
 * @throws {TypeError} If the handler is not a function or an object whose keys do not correspond to keys in the state `machine`
 * @throws {TypeError} If the state machine has any values which are not objects
 * @throws {TypeError} If the state machine's "sub-objects" has values that are not keys on the root of the object
 * @param {function|Object&lt;string, function>} handler A handler function or an object of individual handler function (the keys on the object must match possible "states" otherwise they'll never be called)
 * @param {Object&lt;string, Object&lt;string, string>>} machine An object whose keys are possible states and whose values are also objects (but whose keys are transition names and whose values are states they will advance to)
 * @returns {function} A wrapped handler function that is ready to receive the (1) initial data, (2) starting "state" value on the machine, and (3) an object containing any dependencies the handler may have
 */
function createTransitionHandler(handler, machine) {
  if (!machine) {
    throw new TypeError('A state machine is required but was not provided')
  }
  if (!handler) {
    throw new TypeError('A handler is required for the state machine transitions')
  }

  validateStateMachine(machine)

  const getStateHandler = typeof handler === 'function'
    ? () => handler
    : handler &amp;&amp; typeof handler === 'object' &amp;&amp; handler.constructor.name === 'Object'
      ? currentState => {
        if (typeof handler[currentState] !== 'function') {
          throw new TypeError(`No handler was defined for the current state of '${currentState}'`)
        }
        return handler[currentState]
      } : undefined

  if (!getStateHandler) {
    throw new TypeError(
      'handler must be a function or an object whose keys are state names and whose values are functions'
    )
  }

  /**
   * A handler function that will advance from state to state - executing each piece of logic and/or async function the user defined, until the state can no longer advance and the current value or error is returned at that point.
   *
   * @function
   * @name wrappedTransitionHandler
   * @throws {TransitionError} If the handler encounters an unexpected exception
   * @param {Object&lt;string, any>} initialData Any starting data for the handler
   * @param {string} initialState A starting "state" value which should be one of the possible values on the state machine
   * @param {Object&lt;string, any>} [context] An optional object containing any dependencies of the handler (API clients, caches, etc.)
   * @returns {*} When the handler can no longer advance to another possible state, the value of the last function it executed is returned
   */
  return async function wrappedTransitionHandler(initialData, initialState, context) {
    const nextState = createMachine(machine, initialState || 'initial')
    let currentState
    let result = initialData

    try {
      while (currentState !== nextState()) {
        currentState = nextState()
        result = await getStateHandler(currentState)(result, nextState, context)
      }

      if (result &amp;&amp; /Error$/.test(result.constructor.name)) {
        throw result
      }

      return result
    } catch (err) {
      throw new TransitionError(
        err.message || err.toString(),
        nextState(), {
          ...((err.data &amp;&amp; typeof err.data === 'object') || {}),
          ...((err.extensions &amp;&amp; typeof err.extensions === 'object') || {})
        }
      )
    }
  }
}

module.exports = createTransitionHandler
</code></pre>
        </article>
    </section>




</div>

<footer>
    <img class="logo" src="https://arizonatribe.github.io/machines/styles/logo.png" style="width: 1px; height: 1px">
    <div class="footer-text">Simplified state machines</div>
</footer>
<script>prettyPrint();</script>
<script src="scripts/jquery.min.js"></script>
<script src="scripts/tui-doc.js"></script>
<script src="scripts/linenumber.js"></script>

    <script>
        var id = '_sub'.replace(/"/g, '_');
        var selectedApi = document.getElementById(id); // do not use jquery selector
        var $selectedApi = $(selectedApi);

        $selectedApi.removeClass('hidden');
        $selectedApi.parent().find('.glyphicon').removeClass('glyphicon-plus').addClass('glyphicon-minus');
        showLnbApi();
    </script>

</body>
</html>
